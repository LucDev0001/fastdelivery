<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Status da Instalação - CoraEats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50 min-h-screen py-10 px-4">
    <div class="max-w-3xl mx-auto">
      <div class="text-center mb-10">
        <img
          src="images/logocora.png"
          alt="CoraEats"
          class="h-16 mx-auto rounded-lg mb-4 shadow-md"
        />
        <h1 class="text-3xl font-bold text-gray-800">
          Acompanhamento de Instalação
        </h1>
        <p class="text-gray-600 mt-2">
          Veja em que etapa está a configuração da sua loja.
        </p>
      </div>

      <div id="loading" class="text-center py-10">
        <i class="fas fa-circle-notch fa-spin text-4xl text-[#F47C2C]"></i>
        <p class="mt-4 text-gray-500">Buscando informações...</p>
      </div>

      <div
        id="status-container"
        class="bg-white rounded-xl shadow-lg p-8 hidden"
      >
        <div class="mb-8 border-b pb-4">
          <h2 class="text-xl font-bold text-gray-800" id="store-name">
            Carregando...
          </h2>
          <p class="text-sm text-gray-500">
            Chave:
            <span
              id="license-key"
              class="font-mono bg-gray-100 px-2 py-1 rounded"
              >...</span
            >
          </p>
        </div>

        <!-- Timeline -->
        <div class="relative">
          <!-- Linha Vertical -->
          <div
            class="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-200"
            style="z-index: 0"
          ></div>

          <!-- Passo 1: Pagamento -->
          <div class="relative flex items-start mb-8 z-10" id="step-payment">
            <div
              class="flex-shrink-0 w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center border-4 border-white shadow-sm transition-colors duration-300"
            >
              <i class="fas fa-credit-card text-gray-400 text-xl"></i>
            </div>
            <div class="ml-6 mt-2">
              <h3 class="text-lg font-bold text-gray-900">Pagamento</h3>
              <p class="text-gray-500 text-sm">
                Aguardando confirmação do pagamento.
              </p>
            </div>
          </div>

          <!-- Passo 2: Contrato -->
          <div class="relative flex items-start mb-8 z-10" id="step-contract">
            <div
              class="flex-shrink-0 w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center border-4 border-white shadow-sm transition-colors duration-300"
            >
              <i class="fas fa-file-signature text-gray-400 text-xl"></i>
            </div>
            <div class="ml-6 mt-2">
              <h3 class="text-lg font-bold text-gray-900">
                Assinatura do Contrato
              </h3>
              <p class="text-gray-500 text-sm">
                Aguardando sua assinatura digital.
              </p>
              <a
                href="#"
                id="contract-link"
                class="text-[#F47C2C] text-sm font-bold hover:underline mt-1 block hidden"
                >Assinar Agora &rarr;</a
              >
            </div>
          </div>

          <!-- Passo 3: Materiais -->
          <div class="relative flex items-start mb-8 z-10" id="step-materials">
            <div
              class="flex-shrink-0 w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center border-4 border-white shadow-sm transition-colors duration-300"
            >
              <i class="fas fa-box-open text-gray-400 text-xl"></i>
            </div>
            <div class="ml-6 mt-2">
              <h3 class="text-lg font-bold text-gray-900">
                Envio de Materiais
              </h3>
              <p class="text-gray-500 text-sm">
                Aguardando envio do Logo, Capa e Cardápio.
              </p>
            </div>
          </div>

          <!-- Passo 4: Configuração -->
          <div class="relative flex items-start mb-8 z-10" id="step-config">
            <div
              class="flex-shrink-0 w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center border-4 border-white shadow-sm transition-colors duration-300"
            >
              <i class="fas fa-server text-gray-400 text-xl"></i>
            </div>
            <div class="ml-6 mt-2">
              <h3 class="text-lg font-bold text-gray-900">
                Configuração Técnica
              </h3>
              <p class="text-gray-500 text-sm">
                Configurando Servidor, DNS e Domínio.
              </p>
            </div>
          </div>

          <!-- Passo 5: Pronto -->
          <div class="relative flex items-start z-10" id="step-ready">
            <div
              class="flex-shrink-0 w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center border-4 border-white shadow-sm transition-colors duration-300"
            >
              <i class="fas fa-rocket text-gray-400 text-xl"></i>
            </div>
            <div class="ml-6 mt-2">
              <h3 class="text-lg font-bold text-gray-900">Loja Pronta!</h3>
              <p class="text-gray-500 text-sm">Seu sistema está no ar.</p>
              <a
                href="#"
                id="store-link"
                target="_blank"
                class="hidden mt-2 inline-block bg-green-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-600 transition"
                >Acessar Loja</a
              >
            </div>
          </div>
        </div>
      </div>

      <div
        id="error-msg"
        class="hidden text-center py-10 text-red-600 bg-white rounded-xl shadow p-6 mt-4"
      >
        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
        <p>Licença não encontrada ou chave inválida.</p>
        <a href="index.html" class="text-blue-600 underline mt-2 block"
          >Voltar ao início</a
        >
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBJspCFmB7IQQdLdxLYQrZZ-TFAiDPXrXk",
        authDomain: "fastdelivery-46457.firebaseapp.com",
        projectId: "fastdelivery-46457",
        storageBucket: "fastdelivery-46457.appspot.com",
        messagingSenderId: "889884008498",
        appId: "1:889884008498:web:418e00c16326df6d4e1c2b",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      async function loadStatus() {
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get("key");

        if (!key) {
          document.getElementById("loading").classList.add("hidden");
          document.getElementById("error-msg").classList.remove("hidden");
          return;
        }

        try {
          const q = query(collection(db, "licenses"), where("key", "==", key));
          const snapshot = await getDocs(q);

          if (snapshot.empty) {
            throw new Error("Not found");
          }

          const data = snapshot.docs[0].data();
          document.getElementById("loading").classList.add("hidden");
          document
            .getElementById("status-container")
            .classList.remove("hidden");

          document.getElementById("store-name").innerText =
            data.storeName || "Sua Loja";
          document.getElementById("license-key").innerText = data.key;

          // Helper para ativar steps
          const activate = (id, iconClass, textClass = "text-green-600") => {
            const el = document.getElementById(id);
            const iconContainer = el.querySelector("div");
            const icon = el.querySelector("i");
            iconContainer.className = `flex-shrink-0 w-16 h-16 rounded-full bg-green-100 flex items-center justify-center border-4 border-white shadow-sm`;
            icon.className = `fas ${iconClass} ${textClass} text-xl`;
          };

          // Lógica de Pagamento
          if (data.status === "paid" || data.active) {
            activate("step-payment", "fa-check");
            document.querySelector("#step-payment h3").innerText =
              "Pagamento Confirmado";
            document.querySelector("#step-payment p").innerText =
              "Sua assinatura foi processada com sucesso.";
          }

          // Lógica de Status
          if (data.contractAccepted) activate("step-contract", "fa-check");
          else {
            document.getElementById("contract-link").href =
              `contrato.html?key=${key}`;
            document.getElementById("contract-link").classList.remove("hidden");
          }

          const status = data.setupStatus || "pending"; // pending, waiting_materials, configuring, ready

          if (
            status === "waiting_materials" ||
            status === "configuring" ||
            status === "ready"
          )
            activate("step-materials", "fa-check");
          if (status === "configuring" || status === "ready")
            activate("step-config", "fa-cog fa-spin", "text-blue-600");
          if (status === "ready") {
            activate("step-config", "fa-check");
            activate("step-ready", "fa-check");
            if (data.storeUrl) {
              const btn = document.getElementById("store-link");
              btn.href = data.storeUrl.startsWith("http")
                ? data.storeUrl
                : `https://${data.storeUrl}`;
              btn.classList.remove("hidden");
            }
          }
        } catch (e) {
          console.error(e);
          document.getElementById("loading").classList.add("hidden");
          document.getElementById("error-msg").classList.remove("hidden");
        }
      }

      loadStatus();
    </script>
  </body>
</html>
