rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Função para verificar se o usuário é o Admin específico
    function isAdmin() {
      return request.auth != null && request.auth.uid == "DGfO0ZsoU0W7CXbDdbYPRSmweKx2";
    }

    // Regras para a coleção de licenças
    match /licenses/{document=**} {
      // Leitura pública necessária para o contrato.html validar a chave
      allow read: if true;
      
      // Apenas o Admin pode criar ou deletar
      allow create, delete: if isAdmin();
      
      // Atualização: Admin OU Cliente assinando o contrato (transição estrita)
      allow update: if isAdmin() || (
        resource.data.status == 'paid' && 
        resource.data.active == false &&
        request.resource.data.contractAccepted == true &&
        request.resource.data.active == true
      );
    }

    // Regras para a coleção de tickets
    match /tickets/{ticketId} {
      // Qualquer um cria, lê e atualiza (para responder mensagens)
      allow create: if true;
      allow read: if true;
      allow update: if true;
      
      // Apenas admin deleta
      allow delete: if isAdmin();
    }

    // Regras para configuração (Preços)
    match /config/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Regras para notificações (Admin)
    match /notifications/{notificationId} {
      allow read, write: if isAdmin();
    }
  }
}
