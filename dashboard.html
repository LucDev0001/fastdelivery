<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Licen√ßas</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100">
    <div
      id="loader"
      class="fixed inset-0 bg-white flex items-center justify-center z-50"
    >
      <p>Carregando...</p>
    </div>

    <div id="app" class="hidden">
      <header class="bg-white shadow-sm">
        <div
          class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center"
        >
          <h1 class="text-xl font-bold text-gray-900">
            Gerenciador de Licen√ßas
          </h1>
          <div class="flex items-center gap-6">
            <!-- Notifica√ß√µes -->
            <div class="relative">
              <button id="btn-notifications" class="relative text-gray-500 hover:text-gray-700 focus:outline-none">
                <i class="fas fa-bell text-xl"></i>
                <span id="badge-notifications" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
              </button>
              
              <!-- Dropdown de Notifica√ß√µes -->
              <div id="dropdown-notifications" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                <div class="p-3 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-lg">
                  <h3 class="text-sm font-bold text-gray-700">Vendas do Site (Pendentes)</h3>
                  <button id="btn-clear-notifications" class="text-xs text-blue-600 hover:underline">Marcar todas como lidas</button>
                </div>
                <div id="list-notifications" class="max-h-64 overflow-y-auto divide-y divide-gray-100">
                  <!-- Itens ser√£o inseridos aqui -->
                </div>
              </div>
            </div>

            <button
              id="logout-button"
              class="text-sm text-red-600 hover:underline"
            >
              Sair
            </button>
          </div>
        </div>
      </header>

      <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Estat√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Crescimento de Clientes</h2>
            <canvas id="chartClientes"></canvas>
          </div>
          <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Faturamento Estimado</h2>
            <canvas id="chartFaturamento"></canvas>
          </div>
        </div>

        <!-- Configura√ß√£o de Pre√ßos -->
        <div class="bg-white p-6 rounded-lg shadow mb-8">
          <h2 class="text-lg font-semibold mb-4">Configura√ß√£o de Pre√ßos</h2>
          <form id="pricing-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div>
              <label class="block text-sm font-medium text-gray-700">Plano Mensal (R$)</label>
              <input type="number" id="price-monthly" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Plano Anual (R$)</label>
              <input type="number" id="price-annual" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required>
            </div>
            <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 h-10">
              Salvar Pre√ßos
            </button>
          </form>
        </div>

        <!-- Gerenciamento de Licen√ßas -->
        <div class="bg-white p-6 rounded-lg shadow mb-8">
          <h2 class="text-lg font-semibold mb-4">Adicionar Nova Licen√ßa</h2>
          <form
            id="add-license-form"
            class="grid grid-cols-1 md:grid-cols-3 gap-4"
          >
            <input
              type="text"
              id="store-name"
              placeholder="Nome da Loja"
              required
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="company-name"
              placeholder="Raz√£o Social"
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="cnpj"
              placeholder="CPF ou CNPJ"
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="store-url"
              placeholder="URL da Loja (https://...)"
              required
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="client-contact"
              placeholder="E-mail do Cliente"
              required
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="client-phone"
              placeholder="WhatsApp (com DDD)"
              required
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="address"
              placeholder="Endere√ßo Completo"
              class="p-2 border rounded md:col-span-2"
            />
            <select id="plan-type" class="p-2 border rounded bg-white">
              <option value="mensal">Plano Mensal</option>
              <option value="anual">Plano Anual</option>
            </select>
            <input
              type="date"
              id="expires-at"
              required
              class="p-2 border rounded"
            />
            <textarea id="internal-notes" placeholder="Observa√ß√µes Internas (Instala√ß√£o, Detalhes...)" class="p-2 border rounded md:col-span-3" rows="2"></textarea>
            <div class="md:col-span-3 flex items-center gap-2 py-2">
              <input type="checkbox" id="already-paid" class="w-4 h-4 text-emerald-600 rounded border-gray-300 focus:ring-emerald-500">
              <label for="already-paid" class="text-sm text-gray-700 font-medium">Cliente j√° pagou pelo site (Gerar apenas chave e contrato)</label>
            </div>
            <div class="md:col-span-3 flex flex-col md:flex-row gap-4">
              <button
                type="submit"
                class="flex-1 bg-[#10B981] text-white py-2 rounded hover:bg-emerald-600"
              >
                Gerar Licen√ßa
              </button>
              <button
                type="button"
                id="btn-generate-test"
                class="flex-1 bg-gray-800 text-white py-2 rounded hover:bg-gray-900"
              >
                <i class="fas fa-flask mr-2"></i>Gerar Teste Gr√°tis (7 dias)
              </button>
            </div>
          </form>
          <div
            id="generated-key"
            class="mt-4 bg-green-100 text-green-800 p-3 rounded hidden text-center font-mono"
          ></div>
        </div>

        <!-- Lista de Licen√ßas -->
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
          <div
            class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center flex-wrap gap-4"
          >
            <h3 class="text-lg font-medium text-gray-900">Licen√ßas Ativas</h3>
            <div class="relative">
              <span
                class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"
              >
                <i class="fas fa-search"></i>
              </span>
              <input
                type="text"
                id="search-license"
                placeholder="Buscar loja ou cliente..."
                class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 text-sm w-64"
              />
            </div>
          </div>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                >
                  Loja
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                >
                  Status
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                >
                  Perfil
                </th>
              </tr>
            </thead>
            <tbody
              id="licenses-table"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Linhas ser√£o inseridas via JS -->
            </tbody>
          </table>
        </div>

        <!-- Sistema de Suporte (Admin View) -->
        <div class="mt-12">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">
            Tickets de Suporte
          </h2>
          <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div id="tickets-container" class="divide-y divide-gray-200">
              <!-- Tickets ser√£o carregados aqui -->
              <p class="p-6 text-gray-500 text-center">Carregando tickets...</p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modal de Edi√ß√£o de Licen√ßa -->
    <div
      id="edit-modal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-lg w-full max-w-2xl shadow-xl flex flex-col max-h-[90vh]">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-lg font-bold text-gray-900" id="edit-modal-title">Editar / Ativar Licen√ßa</h3>
          <button
            onclick="closeEditModal()"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="edit-form" class="p-6 overflow-y-auto space-y-4">
          <input type="hidden" id="edit-id" />
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Nome da Loja</label
            >
            <input
              type="text"
              id="edit-store-name"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Raz√£o Social</label
            >
            <input
              type="text"
              id="edit-company-name"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">CNPJ</label>
            <input
              type="text"
              id="edit-cnpj"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">URL</label>
            <input
              type="text"
              id="edit-store-url"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Contato</label
            >
            <input
              type="text"
              id="edit-client-contact"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Telefone (WhatsApp)</label>
            <input
              type="text"
              id="edit-client-phone"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Endere√ßo</label
            >
            <input
              type="text"
              id="edit-address"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Vencimento</label
            >
            <input
              type="date"
              id="edit-expires-at"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Status do Pagamento</label>
            <select id="edit-payment-status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
              <option value="aguardando_pagamento">Aguardando Pagamento</option>
              <option value="paid">Pago (Liberar Contrato)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Status da Instala√ß√£o</label>
            <select id="edit-setup-status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
              <option value="pending">Aguardando In√≠cio</option>
              <option value="waiting_materials">Aguardando Materiais</option>
              <option value="configuring">Configurando DNS/Servidor</option>
              <option value="ready">Pronto para Uso</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Atualize para o cliente acompanhar no link de status.</p>
          </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Observa√ß√µes Internas</label>
            <textarea id="edit-internal-notes" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500" rows="3"></textarea>
          </div>
          
          <div class="flex justify-end gap-3 pt-4 border-t">
            <button
              type="button"
              onclick="closeEditModal()"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              Salvar Altera√ß√µes
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de Detalhes da Licen√ßa (Perfil) -->
    <div id="license-details-modal" class="fixed inset-0 bg-gray-100 z-50 hidden overflow-y-auto">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex justify-between items-center mb-6">
          <button onclick="closeLicenseDetails()" class="flex items-center text-gray-600 hover:text-gray-900 font-medium">
            <i class="fas fa-arrow-left mr-2"></i> Voltar para Lista
          </button>
          <h1 class="text-2xl font-bold text-gray-900">Detalhes da Licen√ßa</h1>
        </div>

        <div class="bg-white shadow rounded-lg overflow-hidden">
          <!-- Header do Perfil -->
          <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center flex-wrap gap-4">
            <div>
              <h2 class="text-xl font-bold text-gray-900" id="detail-store-name">Nome da Loja</h2>
              <a href="#" target="_blank" id="detail-store-url" class="text-sm text-blue-600 hover:underline">url.com</a>
            </div>
            <div class="flex gap-2" id="detail-badges">
              <!-- Badges inseridos via JS -->
            </div>
          </div>

          <!-- Corpo do Perfil -->
          <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Informa√ß√µes Principais -->
            <div class="space-y-4">
              <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Informa√ß√µes da Empresa</h3>
              <p class="text-sm"><span class="font-bold text-gray-500 block">Raz√£o Social:</span> <span id="detail-company"></span></p>
              <p class="text-sm"><span class="font-bold text-gray-500 block">CNPJ:</span> <span id="detail-cnpj"></span></p>
              <p class="text-sm"><span class="font-bold text-gray-500 block">Endere√ßo:</span> <span id="detail-address"></span></p>
            </div>

            <!-- Contato -->
            <div class="space-y-4">
              <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Contato</h3>
              <p class="text-sm"><span class="font-bold text-gray-500 block">Nome/Email:</span> <span id="detail-contact"></span></p>
              <p class="text-sm"><span class="font-bold text-gray-500 block">Telefone:</span> <span id="detail-phone"></span></p>
            </div>

            <!-- Licen√ßa e Sistema -->
            <div class="space-y-4 md:col-span-2">
              <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Dados da Licen√ßa</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <p class="text-sm"><span class="font-bold text-gray-500 block">Chave:</span> <code id="detail-key" class="bg-gray-100 px-2 py-1 rounded"></code></p>
                <p class="text-sm"><span class="font-bold text-gray-500 block">Plano:</span> <span id="detail-plan"></span></p>
                <p class="text-sm"><span class="font-bold text-gray-500 block">Expira em:</span> <span id="detail-expires"></span></p>
              </div>
            </div>

            <!-- Status Instala√ß√£o -->
            <div class="space-y-4 md:col-span-2 bg-blue-50 p-4 rounded-lg">
              <h3 class="text-lg font-medium text-blue-900">Status da Instala√ß√£o</h3>
              <div id="detail-setup-container">
                <!-- Select inserido via JS -->
              </div>
            </div>

            <!-- Observa√ß√µes -->
            <div class="space-y-4 md:col-span-2">
              <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Observa√ß√µes Internas</h3>
              <p id="detail-notes" class="text-sm text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap"></p>
            </div>
          </div>

          <!-- Barra de A√ß√µes -->
          <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex flex-wrap gap-3 justify-end" id="detail-actions">
            <!-- Bot√µes inseridos via JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Resposta -->
    <div
      id="reply-modal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-lg w-full max-w-2xl mx-4 flex flex-col max-h-[80vh]"
      >
        <div class="p-4 border-b flex justify-between items-center">
          <h3 class="font-bold text-lg" id="modal-ticket-title">
            Responder Ticket
          </h3>
          <button
            onclick="closeReplyModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div
          id="modal-messages"
          class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"
        >
          <!-- Mensagens -->
        </div>
        <form id="reply-form" class="p-4 border-t bg-white">
          <input type="hidden" id="modal-ticket-id" />
          <div class="flex gap-2">
            <input
              type="text"
              id="reply-input"
              class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Digite sua resposta..."
              required
            />
            <button
              type="submit"
              class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-medium"
            >
              Enviar
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        serverTimestamp,
        deleteDoc,
        doc,
        query,
        orderBy,
        updateDoc,
        arrayUnion,
        onSnapshot,
        setDoc,
        getDoc,
        writeBatch,
        where,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBJspCFmB7IQQdLdxLYQrZZ-TFAiDPXrXk",
        authDomain: "fastdelivery-46457.firebaseapp.com",
        projectId: "fastdelivery-46457",
        storageBucket: "fastdelivery-46457.appspot.com",
        messagingSenderId: "889884008498",
        appId: "1:889884008498:web:418e00c16326df6d4e1c2b",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const adminUID = "DGfO0ZsoU0W7CXbDdbYPRSmweKx2";

      // Vari√°veis globais para gr√°ficos
      let chartClientesInstance = null;
      let chartFaturamentoInstance = null;
      let allLicensesData = []; // Cache local para busca

      // Fun√ß√£o global para copiar
      window.copiarChave = (texto) => {
        navigator.clipboard.writeText(texto).then(() => {
          alert("Copiado com sucesso!");
        });
      };

      // Fun√ß√µes do Modal de Resposta
      window.closeReplyModal = () => {
        document.getElementById("reply-modal").classList.add("hidden");
        document.getElementById("reply-modal").classList.remove("flex");
      };

      window.closeEditModal = () => {
        document.getElementById("edit-modal").classList.add("hidden");
        document.getElementById("edit-modal").classList.remove("flex");
      };

      window.openReplyModal = (ticketId, subject, messages) => {
        document.getElementById("modal-ticket-id").value = ticketId;
        document.getElementById("modal-ticket-title").textContent = subject;

        const msgContainer = document.getElementById("modal-messages");
        msgContainer.innerHTML = "";

        messages.forEach((msg) => {
          const isSupport = msg.sender === "support";
          const div = document.createElement("div");
          div.className = `flex ${isSupport ? "justify-end" : "justify-start"}`;
          div.innerHTML = `
                  <div class="max-w-[80%] rounded-lg p-3 ${
                    isSupport
                      ? "bg-blue-100 text-blue-900"
                      : "bg-white border text-gray-800"
                  }">
                      <p class="text-xs font-bold mb-1">${
                        isSupport ? "Suporte" : "Lojista"
                      }</p>
                      <p>${msg.text}</p>
                      <p class="text-[10px] opacity-70 mt-1 text-right">${new Date(
                        msg.timestamp?.toDate()
                      ).toLocaleString()}</p>
                  </div> 
              `;
          msgContainer.appendChild(div);
        });

        // Scroll para o final
        msgContainer.scrollTop = msgContainer.scrollHeight;

        const modal = document.getElementById("reply-modal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      };

      // Prote√ß√£o de Rota
      onAuthStateChanged(auth, (user) => {
        if (user && user.uid === adminUID) {
          document.getElementById("loader").classList.add("hidden");
          document.getElementById("app").classList.remove("hidden");
          loadLicenses();
          loadTickets();
          loadPricing();
          loadNotifications();
        } else {
          // Redireciona imediatamente se n√£o for o admin
          window.location.replace("login.html");
        }
      });

      // Logout
      document.getElementById("logout-button").addEventListener("click", () => {
        signOut(auth).then(() => (window.location.href = "login.html"));
      });

      // --- SISTEMA DE NOTIFICA√á√ïES ---
      function loadNotifications() {
        const q = query(collection(db, "notifications"), where("read", "==", false), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
          const list = document.getElementById("list-notifications");
          const badge = document.getElementById("badge-notifications");
          list.innerHTML = "";
          
          if (snapshot.empty) {
            badge.classList.add("hidden");
            list.innerHTML = '<p class="p-4 text-sm text-gray-500 text-center">Nenhuma nova venda pendente.</p>';
            return;
          }

          badge.innerText = snapshot.size;
          badge.classList.remove("hidden");

          snapshot.forEach(doc => {
            const n = doc.data();
            const date = n.createdAt ? new Date(n.createdAt.toDate()).toLocaleString() : "";
            const div = document.createElement("div");
            div.className = "p-3 hover:bg-gray-50 transition";
            div.innerHTML = `
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-sm font-bold text-gray-800">${n.customer.name || "Cliente"}</p>
                  <p class="text-xs text-gray-500">${n.productName} - ${n.customer.email}</p>
                  <p class="text-xs text-gray-400 mt-1">${date}</p>
                </div>
                <button onclick="markNotificationRead('${doc.id}')" class="text-gray-400 hover:text-green-600 p-1" title="Marcar como visto">
                  <i class="fas fa-check"></i>
                </button>
              </div>
            `;
            list.appendChild(div);
          });
        });
      }

      // Fun√ß√£o r√°pida para mudar status da instala√ß√£o na tabela
      window.changeSetupStatus = async (id, newStatus) => {
        const select = document.getElementById(`status-select-${id}`);
        select.disabled = true;
        await updateDoc(doc(db, "licenses", id), { setupStatus: newStatus });
        select.disabled = false;
        // O listener onSnapshot ou reload manual cuidaria da UI, mas aqui damos feedback visual
        select.classList.add("ring-2", "ring-green-500");
        setTimeout(() => select.classList.remove("ring-2", "ring-green-500"), 1000);
      };

      window.markNotificationRead = async (id) => {
        await updateDoc(doc(db, "notifications", id), { read: true });
      };

      document.getElementById("btn-clear-notifications").addEventListener("click", async () => {
        const q = query(collection(db, "notifications"), where("read", "==", false));
        const snapshot = await getDocs(q);
        const batch = writeBatch(db);
        snapshot.forEach(doc => {
          batch.update(doc.ref, { read: true });
        });
        await batch.commit();
      });

      document.getElementById("btn-notifications").addEventListener("click", (e) => {
        e.stopPropagation();
        document.getElementById("dropdown-notifications").classList.toggle("hidden");
      });

      // Fecha dropdown ao clicar fora
      document.addEventListener("click", (e) => {
        const dropdown = document.getElementById("dropdown-notifications");
        const btn = document.getElementById("btn-notifications");
        if (!dropdown.classList.contains("hidden") && !dropdown.contains(e.target) && !btn.contains(e.target)) {
          dropdown.classList.add("hidden");
        }
      });

      // Enviar Resposta
      document
        .getElementById("reply-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const ticketId = document.getElementById("modal-ticket-id").value;
          const text = document.getElementById("reply-input").value;

          if (!text.trim()) return;

          const message = {
            sender: "support",
            text: text,
            timestamp: new Date(),
          };

          await updateDoc(doc(db, "tickets", ticketId), {
            messages: arrayUnion(message),
            status: "answered",
            updatedAt: serverTimestamp(),
            // N√£o fechar automaticamente, deixar o admin decidir
          });

          document.getElementById("reply-input").value = "";
          closeReplyModal();
        });

      // Carregar e Salvar Pre√ßos
      async function loadPricing() {
        try {
          const docSnap = await getDoc(doc(db, "config", "pricing"));
          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById("price-monthly").value = data.monthly;
            document.getElementById("price-annual").value = data.annual;
          }
        } catch (e) {
          console.error("Erro ao carregar pre√ßos", e);
        }
      }

      document.getElementById("pricing-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const monthly = parseFloat(document.getElementById("price-monthly").value);
        const annual = parseFloat(document.getElementById("price-annual").value);
        
        await setDoc(doc(db, "config", "pricing"), {
          monthly, annual
        });
        alert("Pre√ßos atualizados com sucesso!");
      });

      // Gerar Licen√ßa de Teste
      document.getElementById("btn-generate-test").addEventListener("click", async (e) => {
        const btn = e.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i>Gerando...';
        btn.disabled = true;

        try {
           const key = `TEST-${Math.random().toString(36).substr(2, 4).toUpperCase()}-${Math.random().toString(36).substr(2, 4).toUpperCase()}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
           
           const expiresAt = new Date();
           expiresAt.setDate(expiresAt.getDate() + 7); // 7 dias de teste

           const licenseData = {
              storeName: "Loja de Teste " + Math.floor(Math.random() * 10000),
              companyName: "Empresa Teste",
              cnpj: "00.000.000/0000-00",
              address: "Endere√ßo Virtual",
              storeUrl: "",
              clientContact: "teste@coraeats.app",
              planType: "trial",
              expiresAt: expiresAt,
              createdAt: serverTimestamp(),
              key: key,
              paymentId: "TRIAL_GENERATED",
              paymentLink: "#",
              active: true, 
              status: "trial",
              contractAccepted: false 
           };

           await addDoc(collection(db, "licenses"), licenseData);

           const keyContainer = document.getElementById("generated-key");
           keyContainer.innerHTML = `
            <div class="flex flex-col gap-4 text-left">
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                    <p class="font-bold text-blue-800"><i class="fas fa-check-circle"></i> Licen√ßa de Teste Criada!</p>
                    <p class="text-sm text-blue-700">Esta licen√ßa j√° est√° ativa e v√°lida por 7 dias.</p>
                </div>
                <div>
                    <span class="text-sm font-bold text-gray-600">Chave da Licen√ßa:</span>
                    <div class="flex gap-2 mt-1">
                        <input type="text" value="${key}" class="flex-1 p-2 border rounded text-sm bg-gray-50 font-mono" readonly>
                        <button onclick="window.copiarChave('${key}')" class="bg-gray-600 text-white px-3 rounded hover:bg-gray-700">Copiar</button>
                    </div>
                </div>
            </div>
          `;
           keyContainer.classList.remove("hidden");
           loadLicenses();

        } catch (error) {
            console.error(error);
            alert("Erro ao gerar licen√ßa de teste: " + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
      });

      // Adicionar Licen√ßa
      document
        .getElementById("add-license-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const btn = e.target.querySelector("button[type=submit]");
          const alreadyPaid = document.getElementById("already-paid").checked;
          const originalText = btn.innerText;
          btn.innerText = "Gerando Link de Pagamento...";
          btn.disabled = true;

          try {
            // 1. Gera a chave localmente
            const key = `VOU-${Math.random()
              .toString(36)
              .substr(2, 4)
              .toUpperCase()}-${Math.random()
              .toString(36)
              .substr(2, 4)
              .toUpperCase()}-${Math.random()
              .toString(36)
              .substr(2, 4)
              .toUpperCase()}`;

            // 2. Coleta dados do formul√°rio
            const storeName = document.getElementById("store-name").value;
            const companyName = document.getElementById("company-name").value;
            const cnpj = document.getElementById("cnpj").value;
            const email = document.getElementById("client-contact").value;
            const phone = document.getElementById("client-phone").value;
            const planType = document.getElementById("plan-type").value;
            const internalNotes = document.getElementById("internal-notes").value;

            let paymentData = { id: "MANUAL_SITE_" + Date.now(), url: "#" };

            if (!alreadyPaid) {
              // 3. Chama a API para gerar o Link de Pagamento (apenas se n√£o pagou)
              const checkoutResponse = await fetch("/api/checkout", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  name: companyName || storeName,
                  email: email,
                  cpf: cnpj,
                  plan: planType,
                  phone: phone,
                  key: key, // Envia a chave para vincular ao redirecionamento
                }),
              });

              if (!checkoutResponse.ok) {
                const errorText = await checkoutResponse.text(); // L√™ o corpo como texto primeiro
                let errorMsg = "Erro ao gerar pagamento";
                
                try {
                  const errorData = JSON.parse(errorText); // Tenta converter para JSON
                  errorMsg = errorData.error || errorMsg;
                } catch (e) {
                  // Se falhar, √© HTML ou texto puro (erro cr√≠tico do Vercel/Node)
                  console.error("Erro Cr√≠tico do Servidor:", errorText);
                  errorMsg = `Erro no Servidor (${checkoutResponse.status}). Verifique o console para ver o erro detalhado.`;
                }
                throw new Error(errorMsg);
              }
              paymentData = await checkoutResponse.json();
            }

            // 4. Salva no Firestore (Inativa / Aguardando Pagamento)
            const licenseData = {
              storeName: storeName,
              companyName: companyName,
              cnpj: cnpj,
              address: document.getElementById("address").value,
              storeUrl: document.getElementById("store-url").value,
              clientContact: email,
              clientPhone: phone, // Salva o telefone
              planType: planType,
              internalNotes: internalNotes, // Salva observa√ß√µes
              expiresAt: new Date(
                document.getElementById("expires-at").value + "T23:59:59"
              ),
              createdAt: serverTimestamp(),
              key: key,
              paymentId: paymentData.id, // ID do Abacate Pay para vincular
              paymentLink: paymentData.url,
              active: false, // Come√ßa inativa
              status: alreadyPaid ? "paid" : "aguardando_pagamento",
            };

            await addDoc(collection(db, "licenses"), licenseData);

            const keyContainer = document.getElementById("generated-key");
            keyContainer.innerHTML = `
            <div class="flex flex-col gap-4 text-left">
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                    <p class="font-bold text-yellow-800"><i class="fas fa-exclamation-triangle"></i> Licen√ßa criada (${alreadyPaid ? 'Paga / Aguardando Contrato' : 'Aguardando Pagamento'})</p>
                    <p class="text-sm text-yellow-700">Envie o ${alreadyPaid ? 'link do contrato' : 'link de pagamento'} para o cliente ativar a chave.</p>
                </div>
                ${!alreadyPaid ? `<div>
                    <span class="text-sm font-bold text-gray-600">Link de Pagamento:</span>
                    <div class="flex gap-2 mt-1">
                        <input type="text" value="${paymentData.url}" class="flex-1 p-2 border rounded text-sm bg-gray-50" readonly>
                        <button onclick="window.copiarChave('${paymentData.url}')" class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700">Copiar</button>
                    </div>
                </div>` : ''}
                <div>
                    <span class="text-sm font-bold text-gray-600">Chave da Licen√ßa:</span>
                    <div class="flex gap-2 mt-1">
                        <input type="text" value="${key}" class="flex-1 p-2 border rounded text-sm bg-gray-50 font-mono" readonly>
                        <button onclick="window.copiarChave('${key}')" class="bg-gray-600 text-white px-3 rounded hover:bg-gray-700">Copiar</button>
                    </div>
                </div>
            </div>`;
            keyContainer.classList.remove("hidden");

            e.target.reset();
            loadLicenses();
          } catch (error) {
            console.error(error);
            let msg = error.message;
            if (msg === "Failed to fetch") {
                msg = "N√£o foi poss√≠vel conectar ao servidor. Verifique se o backend (Vercel) est√° rodando.";
            }
            alert(msg);
          } finally {
            btn.innerText = originalText;
            btn.disabled = false;
          }
        });

      // Listener de Busca
      document.getElementById("search-license").addEventListener("input", (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = allLicensesData.filter(
            (l) =>
              l.storeName.toLowerCase().includes(term) ||
              l.clientContact.toLowerCase().includes(term) ||
              l.storeUrl.toLowerCase().includes(term)
          );
          renderLicensesTable(filtered);
        });

      // Carregar Licen√ßas
      async function loadLicenses() {
        const querySnapshot = await getDocs(collection(db, "licenses"));
        allLicensesData = [];
        const stats = {}; // { "2023-10": { clientes: 0, faturamento: 0 } }

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          allLicensesData.push({ id: doc.id, ...data });

          // Processar Estat√≠sticas
          if (data.createdAt) {
            const date = data.createdAt.toDate();
            const key = `${date.getFullYear()}-${String(
              date.getMonth() + 1
            ).padStart(2, "0")}`;

            if (!stats[key]) stats[key] = { clientes: 0, faturamento: 0 };

            stats[key].clientes++;
            const valor = data.planType === "anual" ? 990 : 99;
            stats[key].faturamento += valor;
          }
        });

        renderLicensesTable(allLicensesData);
        renderCharts(stats);
      }

      function renderLicensesTable(licenses) {
        const tableBody = document.getElementById("licenses-table");
        tableBody.innerHTML = "";

        // Base URL para o contrato
        const baseUrl =
          window.location.origin +
          window.location.pathname.substring(
            0,
            window.location.pathname.lastIndexOf("/")
          ) +
          "/contrato.html";

        licenses.forEach((data) => {
          const expiresDateObj = data.expiresAt.toDate();
          const expiresDate = expiresDateObj.toLocaleDateString("pt-BR");
          const isExpired = expiresDateObj < new Date();
          const contractUrl = `${baseUrl}?key=${data.key}`;
          const statusUrl = `${baseUrl.replace("contrato.html", "status.html")}?key=${data.key}`;

          const paymentStatus = data.active
            ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Ativa</span>'
            : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Aguardando Pagto</span>';

          const whatsappMessage = `Ol√°! Segue os links para o seu sistema CoraEats:\n\nüìÑ *Contrato/Ativa√ß√£o:* ${contractUrl}\nüìä *Acompanhar Instala√ß√£o:* ${statusUrl}`;

          const whatsappLink = data.clientPhone 
            ? `https://wa.me/${data.clientPhone.replace(/\D/g, '')}?text=${encodeURIComponent(whatsappMessage)}`
            : '#';

          // L√≥gica do Bot√£o de A√ß√£o (Ativar vs Perfil)
          let actionButton = `
            <button onclick="window.openLicenseDetails('${data.id}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition">
              <i class="fas fa-id-card mr-1"></i> Ver Perfil
            </button>`;

          if (!data.storeUrl || data.storeUrl === "") {
             actionButton = `
            <button onclick="window.editLicense('${data.id}')" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition shadow-md animate-pulse">
              <i class="fas fa-check-circle mr-1"></i> ATIVAR
            </button>`;
          }

          const row = `
                    <tr class="${isExpired ? "bg-red-50" : ""}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${
                              data.storeName
                            }</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${paymentStatus}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            ${actionButton}
                        </td>
                    </tr>
                `;
          tableBody.innerHTML += row;
        });
      }

      // --- FUN√á√ïES DE DETALHES DA LICEN√áA (PERFIL) ---
      window.openLicenseDetails = (id) => {
        const data = allLicensesData.find(l => l.id === id);
        if (!data) return;

        // Preencher dados
        document.getElementById("detail-store-name").innerText = data.storeName;
        const urlEl = document.getElementById("detail-store-url");
        urlEl.innerText = data.storeUrl;
        urlEl.href = data.storeUrl.startsWith("http") ? data.storeUrl : `https://${data.storeUrl}`;
        
        document.getElementById("detail-company").innerText = data.companyName || "-";
        document.getElementById("detail-cnpj").innerText = data.cnpj || "-";
        document.getElementById("detail-address").innerText = data.address || "-";
        document.getElementById("detail-contact").innerText = data.clientContact;
        document.getElementById("detail-phone").innerText = data.clientPhone || "-";
        document.getElementById("detail-key").innerText = data.key;
        document.getElementById("detail-plan").innerText = data.planType;
        document.getElementById("detail-notes").innerText = data.internalNotes || "Nenhuma observa√ß√£o.";

        const expiresDateObj = data.expiresAt.toDate();
        document.getElementById("detail-expires").innerText = expiresDateObj.toLocaleDateString("pt-BR");

        // Badges
        const badgesContainer = document.getElementById("detail-badges");
        const contractStatus = data.contractAccepted
            ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Contrato Assinado</span>'
            : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Contrato Pendente</span>';
        const paymentStatus = data.active
            ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Licen√ßa Ativa</span>'
            : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Aguardando Pagto</span>';
        badgesContainer.innerHTML = contractStatus + paymentStatus;

        // Setup Status Select
        const setupOptions = {
            pending: "Aguardando In√≠cio",
            waiting_materials: "Aguardando Materiais",
            configuring: "Configurando",
            ready: "Pronto para Uso"
        };
        const setupContainer = document.getElementById("detail-setup-container");
        setupContainer.innerHTML = `
            <select id="status-select-${data.id}" onchange="window.changeSetupStatus('${data.id}', this.value)" class="w-full md:w-1/2 border-gray-300 rounded shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                ${Object.entries(setupOptions).map(([key, label]) => `<option value="${key}" ${data.setupStatus === key ? 'selected' : ''}>${label}</option>`).join('')}
            </select>
        `;

        // Actions Buttons
        const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf("/")) + "/contrato.html";
        const contractUrl = `${baseUrl}?key=${data.key}`;
        const statusUrl = `${baseUrl.replace("contrato.html", "status.html")}?key=${data.key}`;
        const whatsappMessage = `Ol√°! Segue os links para o seu sistema CoraEats:\n\nüìÑ *Contrato/Ativa√ß√£o:* ${contractUrl}\nüìä *Acompanhar Instala√ß√£o:* ${statusUrl}`;
        const whatsappLink = data.clientPhone ? `https://wa.me/${data.clientPhone.replace(/\D/g, '')}?text=${encodeURIComponent(whatsappMessage)}` : '#';

        const actionsContainer = document.getElementById("detail-actions");
        actionsContainer.innerHTML = `
            <button onclick="window.copiarChave('${contractUrl}')" class="bg-purple-100 text-purple-700 px-4 py-2 rounded hover:bg-purple-200"><i class="fas fa-file-contract mr-2"></i>Copiar Contrato</button>
            <button onclick="window.copiarChave('${statusUrl}')" class="bg-orange-100 text-orange-700 px-4 py-2 rounded hover:bg-orange-200"><i class="fas fa-tasks mr-2"></i>Copiar Status</button>
            ${data.clientPhone ? `<a href="${whatsappLink}" target="_blank" class="bg-green-100 text-green-700 px-4 py-2 rounded hover:bg-green-200 flex items-center"><i class="fab fa-whatsapp mr-2"></i>WhatsApp</a>` : ''}
            <button onclick="window.resendWelcomeEmail('${data.id}')" class="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200"><i class="fas fa-envelope mr-2"></i>Reenviar Email</button>
            <button onclick="window.editLicense('${data.id}')" class="bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200"><i class="fas fa-edit mr-2"></i>Editar</button>
            <button onclick="window.renewLicense('${data.id}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"><i class="fas fa-calendar-plus mr-2"></i>Renovar</button>
            <button onclick="window.revokeLicense('${data.id}')" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700"><i class="fas fa-ban mr-2"></i>Revogar</button>
            <button onclick="window.deleteLicense('${data.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"><i class="fas fa-trash mr-2"></i>Excluir</button>
        `;

        document.getElementById("license-details-modal").classList.remove("hidden");
      };

      window.closeLicenseDetails = () => {
        document.getElementById("license-details-modal").classList.add("hidden");
      };

      window.deleteLicense = async (id) => {
        if (confirm("Tem certeza que deseja excluir esta licen√ßa permanentemente?")) {
          await deleteDoc(doc(db, "licenses", id));
          closeLicenseDetails();
          loadLicenses();
        }
      };

      // Fun√ß√µes Globais de Edi√ß√£o e Renova√ß√£o
      window.editLicense = (id) => {
        const license = allLicensesData.find((l) => l.id === id);
        if (!license) return;

        document.getElementById("edit-id").value = id;
        document.getElementById("edit-store-name").value = license.storeName;
        document.getElementById("edit-company-name").value =
          license.companyName || "";
        document.getElementById("edit-cnpj").value = license.cnpj || "";
        document.getElementById("edit-store-url").value = license.storeUrl;
        document.getElementById("edit-client-contact").value =
          license.clientContact;
        document.getElementById("edit-client-phone").value = license.clientPhone || "";
        document.getElementById("edit-address").value = license.address || "";
        document.getElementById("edit-payment-status").value = license.status || "aguardando_pagamento";
        document.getElementById("edit-setup-status").value = license.setupStatus || "pending";
        document.getElementById("edit-internal-notes").value = license.internalNotes || "";
        // Formata data para input date (YYYY-MM-DD)
        const date = license.expiresAt.toDate();
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, "0");
        const dd = String(date.getDate()).padStart(2, "0");
        document.getElementById(
          "edit-expires-at"
        ).value = `${yyyy}-${mm}-${dd}`;

        const modal = document.getElementById("edit-modal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      };

      document
        .getElementById("edit-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("edit-id").value;
          const updates = {
            storeName: document.getElementById("edit-store-name").value,
            companyName: document.getElementById("edit-company-name").value,
            cnpj: document.getElementById("edit-cnpj").value,
            storeUrl: document.getElementById("edit-store-url").value,
            clientContact: document.getElementById("edit-client-contact").value,
            clientPhone: document.getElementById("edit-client-phone").value,
            address: document.getElementById("edit-address").value,
            status: document.getElementById("edit-payment-status").value,
            setupStatus: document.getElementById("edit-setup-status").value,
            internalNotes: document.getElementById("edit-internal-notes").value,
            expiresAt: new Date(
              document.getElementById("edit-expires-at").value + "T23:59:59"
            ),
          };
          await updateDoc(doc(db, "licenses", id), updates);
          closeEditModal();
          loadLicenses();
        });

      window.renewLicense = async (id) => {
        const license = allLicensesData.find((l) => l.id === id);
        if (!license) return;

        if (
          confirm(`Renovar licen√ßa de ${license.storeName} por mais 30 dias?`)
        ) {
          const currentExpire = license.expiresAt.toDate();
          // Adiciona 30 dias
          currentExpire.setDate(currentExpire.getDate() + 30);
          await updateDoc(doc(db, "licenses", id), {
            expiresAt: currentExpire,
          });
          loadLicenses();
        }
      };

      window.revokeLicense = async (id) => {
        const license = allLicensesData.find((l) => l.id === id);
        if (!license) return;

        if (!license.active) {
          alert("Esta licen√ßa j√° est√° inativa.");
          return;
        }

        if (
          confirm(
            `Tem certeza que deseja REVOGAR o acesso de ${license.storeName}? O cliente perder√° o acesso imediatamente.`
          )
        ) {
          await updateDoc(doc(db, "licenses", id), {
            active: false,
          });
          loadLicenses();
        }
      };

      window.resendWelcomeEmail = async (id) => {
        if (!confirm("Tem certeza que deseja reenviar o e-mail de boas-vindas para o cliente?")) return;
        
        try {
            const res = await fetch("/api/send-welcome", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ licenseId: id })
            });
            const data = await res.json();
            if (res.ok) {
                alert("E-mail enviado com sucesso!");
            } else {
                alert("Erro: " + (data.error || "Falha ao enviar"));
            }
        } catch (e) {
            console.error(e);
            alert("Erro de conex√£o ao enviar e-mail.");
        }
      };

      function renderCharts(stats) {
        const sortedKeys = Object.keys(stats).sort();
        const labels = sortedKeys.map((monthYear) => {
          const [year, month] = monthYear.split("-");
          const monthNames = [
            "Jan",
            "Fev",
            "Mar",
            "Abr",
            "Mai",
            "Jun",
            "Jul",
            "Ago",
            "Set",
            "Out",
            "Nov",
            "Dez",
          ];
          return `${monthNames[parseInt(month) - 1]}/${year.slice(2)}`;
        });
        const dataClientes = sortedKeys.map((k) => stats[k].clientes);
        const dataFaturamento = sortedKeys.map((k) => stats[k].faturamento);

        // Gr√°fico Clientes
        if (chartClientesInstance) chartClientesInstance.destroy();
        chartClientesInstance = new Chart(
          document.getElementById("chartClientes"),
          {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Novas Licen√ßas",
                  data: dataClientes,
                  borderColor: "#2563eb",
                  tension: 0.3,
                  fill: true,
                  backgroundColor: "rgba(37, 99, 235, 0.2)",
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `Novas Licen√ßas: ${context.parsed.y}`;
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Quantidade",
                  },
                },
              },
            },
          }
        );

        // Gr√°fico Faturamento
        if (chartFaturamentoInstance) chartFaturamentoInstance.destroy();
        chartFaturamentoInstance = new Chart(
          document.getElementById("chartFaturamento"),
          {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Faturamento Estimado (R$)",
                  data: dataFaturamento,
                  backgroundColor: "#16a34a",
                  borderColor: "#15803d",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `Faturamento: R$ ${context.parsed.y
                        .toFixed(2)
                        .replace(".", ",")}`;
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Valor (R$)",
                  },
                  ticks: {
                    callback: function (value) {
                      return "R$ " + value.toFixed(2).replace(".", ",");
                    },
                  },
                },
              },
            },
          }
        );
      }

      // Carregar Tickets (Realtime)
      function loadTickets() {
        const q = query(
          collection(db, "tickets"),
          orderBy("updatedAt", "desc")
        );
        onSnapshot(q, (snapshot) => {
          const container = document.getElementById("tickets-container");
          container.innerHTML = "";

          if (snapshot.empty) {
            container.innerHTML =
              '<p class="p-6 text-gray-500 text-center">Nenhum ticket de suporte encontrado.</p>';
            return;
          }

          snapshot.forEach((doc) => {
            const t = doc.data();
            const lastMsg = t.messages[t.messages.length - 1];
            const statusColors = {
              open: "bg-yellow-100 text-yellow-800",
              answered: "bg-green-100 text-green-800",
              closed: "bg-gray-100 text-gray-800",
            };
            const statusLabels = {
              open: "Aberto",
              answered: "Respondido",
              closed: "Fechado",
            };

            const div = document.createElement("div");
            div.className = "p-6 hover:bg-gray-50 transition cursor-pointer";
            div.innerHTML = `
                      <div class="flex justify-between items-start">
                          <div>
                              <div class="flex items-center gap-2 mb-1">
                                  <span class="px-2 py-0.5 rounded text-xs font-bold ${
                                    statusColors[t.status] || "bg-gray-100"
                                  }">${
              statusLabels[t.status] || t.status
            }</span>
                                  <h3 class="text-lg font-medium text-gray-900">${
                                    t.subject
                                  }</h3>
                              </div>
                              <p class="text-sm text-gray-500">Loja: <strong>${
                                t.storeName
                              }</strong></p>
                              <p class="text-sm text-gray-600 mt-2 line-clamp-1 text-ellipsis overflow-hidden">
                                  ${
                                    lastMsg
                                      ? lastMsg.text
                                      : "Nenhuma mensagem ainda."
                                  }
                              </p>
                              <button onclick="markTicketAsClosed('${
                                doc.id
                              }')" class="mt-2 text-xs text-gray-500 hover:text-gray-700"><i class="fas fa-check-circle"></i> Marcar como Resolvido</button>
                          </div>
                          <div class="text-right text-xs text-gray-400">
                              ${
                                t.updatedAt
                                  ? new Date(
                                      t.updatedAt.toDate()
                                    ).toLocaleDateString()
                                  : ""
                              }
                          </div>
                      </div>
                  `;
            div.onclick = () => openReplyModal(doc.id, t.subject, t.messages);
            container.appendChild(div);
          });
        });
      }

      // Marcar Ticket como Resolvido
      async function markTicketAsClosed(ticketId) {
        if (
          confirm("Tem certeza que deseja marcar este ticket como RESOLVIDO?")
        ) {
          await updateDoc(doc(db, "tickets", ticketId), {
            status: "closed",
            updatedAt: serverTimestamp(),
          });
        }
      }
    </script>
  </body>
</html>
</html>
