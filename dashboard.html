<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Licenças</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100">
    <div
      id="loader"
      class="fixed inset-0 bg-white flex items-center justify-center z-50"
    >
      <p>Carregando...</p>
    </div>

    <div id="app" class="hidden">
      <header class="bg-white shadow-sm">
        <div
          class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center"
        >
          <h1 class="text-xl font-bold text-gray-900">
            Gerenciador de Licenças
          </h1>
          <button
            id="logout-button"
            class="text-sm text-red-600 hover:underline"
          >
            Sair
          </button>
        </div>
      </header>

      <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Estatísticas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Crescimento de Clientes</h2>
            <canvas id="chartClientes"></canvas>
          </div>
          <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Faturamento Estimado</h2>
            <canvas id="chartFaturamento"></canvas>
          </div>
        </div>

        <!-- Gerenciamento de Licenças -->
        <div class="bg-white p-6 rounded-lg shadow mb-8">
          <h2 class="text-lg font-semibold mb-4">Adicionar Nova Licença</h2>
          <form
            id="add-license-form"
            class="grid grid-cols-1 md:grid-cols-3 gap-4"
          >
            <input
              type="text"
              id="store-name"
              placeholder="Nome da Loja"
              required
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="company-name"
              placeholder="Razão Social"
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="cnpj"
              placeholder="CNPJ"
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="store-url"
              placeholder="URL da Loja (https://...)"
              required
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="client-contact"
              placeholder="E-mail do Cliente"
              required
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="client-phone"
              placeholder="WhatsApp (com DDD)"
              required
              class="p-2 border rounded"
            />
            <input
              type="text"
              id="address"
              placeholder="Endereço Completo"
              class="p-2 border rounded md:col-span-2"
            />
            <select id="plan-type" class="p-2 border rounded bg-white">
              <option value="mensal">Plano Mensal</option>
              <option value="anual">Plano Anual</option>
            </select>
            <input
              type="date"
              id="expires-at"
              required
              class="p-2 border rounded"
            />
            <div class="md:col-span-3 flex flex-col md:flex-row gap-4">
              <button
                type="submit"
                class="flex-1 bg-[#10B981] text-white py-2 rounded hover:bg-emerald-600"
              >
                Gerar Licença
              </button>
              <button
                type="button"
                id="btn-generate-test"
                class="flex-1 bg-gray-800 text-white py-2 rounded hover:bg-gray-900"
              >
                <i class="fas fa-flask mr-2"></i>Gerar Teste Grátis (7 dias)
              </button>
            </div>
          </form>
          <div
            id="generated-key"
            class="mt-4 bg-green-100 text-green-800 p-3 rounded hidden text-center font-mono"
          ></div>
        </div>

        <!-- Lista de Licenças -->
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
          <div
            class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center flex-wrap gap-4"
          >
            <h3 class="text-lg font-medium text-gray-900">Licenças Ativas</h3>
            <div class="relative">
              <span
                class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"
              >
                <i class="fas fa-search"></i>
              </span>
              <input
                type="text"
                id="search-license"
                placeholder="Buscar loja ou cliente..."
                class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 text-sm w-64"
              />
            </div>
          </div>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                >
                  Loja / URL
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                >
                  Chave
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                >
                  Plano
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                >
                  Expira em
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                >
                  Contrato
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                >
                  Ações
                </th>
              </tr>
            </thead>
            <tbody
              id="licenses-table"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Linhas serão inseridas via JS -->
            </tbody>
          </table>
        </div>

        <!-- Sistema de Suporte (Admin View) -->
        <div class="mt-12">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">
            Tickets de Suporte
          </h2>
          <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div id="tickets-container" class="divide-y divide-gray-200">
              <!-- Tickets serão carregados aqui -->
              <p class="p-6 text-gray-500 text-center">Carregando tickets...</p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modal de Edição de Licença -->
    <div
      id="edit-modal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg w-full max-w-md mx-4 p-6 shadow-xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-gray-900">Editar Licença</h3>
          <button
            onclick="closeEditModal()"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="edit-form" class="space-y-4">
          <input type="hidden" id="edit-id" />
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Nome da Loja</label
            >
            <input
              type="text"
              id="edit-store-name"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Razão Social</label
            >
            <input
              type="text"
              id="edit-company-name"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">CNPJ</label>
            <input
              type="text"
              id="edit-cnpj"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">URL</label>
            <input
              type="text"
              id="edit-store-url"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Contato</label
            >
            <input
              type="text"
              id="edit-client-contact"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Endereço</label
            >
            <input
              type="text"
              id="edit-address"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Vencimento</label
            >
            <input
              type="date"
              id="edit-expires-at"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button
              type="button"
              onclick="closeEditModal()"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              Salvar Alterações
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de Resposta -->
    <div
      id="reply-modal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-lg w-full max-w-2xl mx-4 flex flex-col max-h-[80vh]"
      >
        <div class="p-4 border-b flex justify-between items-center">
          <h3 class="font-bold text-lg" id="modal-ticket-title">
            Responder Ticket
          </h3>
          <button
            onclick="closeReplyModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div
          id="modal-messages"
          class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"
        >
          <!-- Mensagens -->
        </div>
        <form id="reply-form" class="p-4 border-t bg-white">
          <input type="hidden" id="modal-ticket-id" />
          <div class="flex gap-2">
            <input
              type="text"
              id="reply-input"
              class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Digite sua resposta..."
              required
            />
            <button
              type="submit"
              class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-medium"
            >
              Enviar
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        serverTimestamp,
        deleteDoc,
        doc,
        query,
        orderBy,
        updateDoc,
        arrayUnion,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBJspCFmB7IQQdLdxLYQrZZ-TFAiDPXrXk",
        authDomain: "fastdelivery-46457.firebaseapp.com",
        projectId: "fastdelivery-46457",
        storageBucket: "fastdelivery-46457.appspot.com",
        messagingSenderId: "889884008498",
        appId: "1:889884008498:web:418e00c16326df6d4e1c2b",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const adminUID = "DGfO0ZsoU0W7CXbDdbYPRSmweKx2";

      // Variáveis globais para gráficos
      let chartClientesInstance = null;
      let chartFaturamentoInstance = null;
      let allLicensesData = []; // Cache local para busca

      // Função global para copiar
      window.copiarChave = (texto) => {
        navigator.clipboard.writeText(texto).then(() => {
          alert("Copiado com sucesso!");
        });
      };

      // Funções do Modal de Resposta
      window.closeReplyModal = () => {
        document.getElementById("reply-modal").classList.add("hidden");
        document.getElementById("reply-modal").classList.remove("flex");
      };

      window.closeEditModal = () => {
        document.getElementById("edit-modal").classList.add("hidden");
        document.getElementById("edit-modal").classList.remove("flex");
      };

      window.openReplyModal = (ticketId, subject, messages) => {
        document.getElementById("modal-ticket-id").value = ticketId;
        document.getElementById("modal-ticket-title").textContent = subject;

        const msgContainer = document.getElementById("modal-messages");
        msgContainer.innerHTML = "";

        messages.forEach((msg) => {
          const isSupport = msg.sender === "support";
          const div = document.createElement("div");
          div.className = `flex ${isSupport ? "justify-end" : "justify-start"}`;
          div.innerHTML = `
                  <div class="max-w-[80%] rounded-lg p-3 ${
                    isSupport
                      ? "bg-blue-100 text-blue-900"
                      : "bg-white border text-gray-800"
                  }">
                      <p class="text-xs font-bold mb-1">${
                        isSupport ? "Suporte" : "Lojista"
                      }</p>
                      <p>${msg.text}</p>
                      <p class="text-[10px] opacity-70 mt-1 text-right">${new Date(
                        msg.timestamp?.toDate()
                      ).toLocaleString()}</p>
                  </div> 
              `;
          msgContainer.appendChild(div);
        });

        // Scroll para o final
        msgContainer.scrollTop = msgContainer.scrollHeight;

        const modal = document.getElementById("reply-modal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      };

      // Proteção de Rota
      onAuthStateChanged(auth, (user) => {
        if (user && user.uid === adminUID) {
          document.getElementById("loader").classList.add("hidden");
          document.getElementById("app").classList.remove("hidden");
          loadLicenses();
          loadTickets();
        } else {
          window.location.href = "login.html";
        }
      });

      // Logout
      document.getElementById("logout-button").addEventListener("click", () => {
        signOut(auth).then(() => (window.location.href = "login.html"));
      });

      // Enviar Resposta
      document
        .getElementById("reply-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const ticketId = document.getElementById("modal-ticket-id").value;
          const text = document.getElementById("reply-input").value;

          if (!text.trim()) return;

          const message = {
            sender: "support",
            text: text,
            timestamp: new Date(),
          };

          await updateDoc(doc(db, "tickets", ticketId), {
            messages: arrayUnion(message),
            status: "answered",
            updatedAt: serverTimestamp(),
            // Não fechar automaticamente, deixar o admin decidir
          });

          document.getElementById("reply-input").value = "";
          closeReplyModal();
        });

      // Gerar Licença de Teste
      document.getElementById("btn-generate-test").addEventListener("click", async (e) => {
        const btn = e.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i>Gerando...';
        btn.disabled = true;

        try {
           const key = `TEST-${Math.random().toString(36).substr(2, 4).toUpperCase()}-${Math.random().toString(36).substr(2, 4).toUpperCase()}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
           
           const expiresAt = new Date();
           expiresAt.setDate(expiresAt.getDate() + 7); // 7 dias de teste

           const licenseData = {
              storeName: "Loja de Teste " + Math.floor(Math.random() * 10000),
              companyName: "Empresa Teste",
              cnpj: "00.000.000/0000-00",
              address: "Endereço Virtual",
              storeUrl: "",
              clientContact: "teste@voufood.app",
              planType: "trial",
              expiresAt: expiresAt,
              createdAt: serverTimestamp(),
              key: key,
              paymentId: "TRIAL_GENERATED",
              paymentLink: "#",
              active: true, 
              status: "trial",
              contractAccepted: false 
           };

           await addDoc(collection(db, "licenses"), licenseData);

           const keyContainer = document.getElementById("generated-key");
           keyContainer.innerHTML = `
            <div class="flex flex-col gap-4 text-left">
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                    <p class="font-bold text-blue-800"><i class="fas fa-check-circle"></i> Licença de Teste Criada!</p>
                    <p class="text-sm text-blue-700">Esta licença já está ativa e válida por 7 dias.</p>
                </div>
                <div>
                    <span class="text-sm font-bold text-gray-600">Chave da Licença:</span>
                    <div class="flex gap-2 mt-1">
                        <input type="text" value="${key}" class="flex-1 p-2 border rounded text-sm bg-gray-50 font-mono" readonly>
                        <button onclick="window.copiarChave('${key}')" class="bg-gray-600 text-white px-3 rounded hover:bg-gray-700">Copiar</button>
                    </div>
                </div>
            </div>
          `;
           keyContainer.classList.remove("hidden");
           loadLicenses();

        } catch (error) {
            console.error(error);
            alert("Erro ao gerar licença de teste: " + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
      });

      // Adicionar Licença
      document
        .getElementById("add-license-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const btn = e.target.querySelector("button[type=submit]");
          const originalText = btn.innerText;
          btn.innerText = "Gerando Link de Pagamento...";
          btn.disabled = true;

          try {
            // 1. Gera a chave localmente
            const key = `VOU-${Math.random()
              .toString(36)
              .substr(2, 4)
              .toUpperCase()}-${Math.random()
              .toString(36)
              .substr(2, 4)
              .toUpperCase()}-${Math.random()
              .toString(36)
              .substr(2, 4)
              .toUpperCase()}`;

            // 2. Coleta dados do formulário
            const storeName = document.getElementById("store-name").value;
            const companyName = document.getElementById("company-name").value;
            const cnpj = document.getElementById("cnpj").value;
            const email = document.getElementById("client-contact").value;
            const phone = document.getElementById("client-phone").value;
            const planType = document.getElementById("plan-type").value;

            // 3. Chama a API para gerar o Link de Pagamento
            const checkoutResponse = await fetch("/api/checkout", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name: companyName || storeName,
                email: email,
                cpf: cnpj,
                plan: planType,
                phone: phone,
                key: key, // Envia a chave para vincular ao redirecionamento
              }),
            });

            if (!checkoutResponse.ok) {
              const errorText = await checkoutResponse.text(); // Lê o corpo como texto primeiro
              let errorMsg = "Erro ao gerar pagamento";
              
              try {
                const errorData = JSON.parse(errorText); // Tenta converter para JSON
                errorMsg = errorData.error || errorMsg;
              } catch (e) {
                // Se falhar, é HTML ou texto puro (erro crítico do Vercel/Node)
                console.error("Erro Crítico do Servidor:", errorText);
                errorMsg = `Erro no Servidor (${checkoutResponse.status}). Verifique o console para ver o erro detalhado.`;
              }
              throw new Error(errorMsg);
            }
            const paymentData = await checkoutResponse.json();

            // 4. Salva no Firestore (Inativa / Aguardando Pagamento)
            const licenseData = {
              storeName: storeName,
              companyName: companyName,
              cnpj: cnpj,
              address: document.getElementById("address").value,
              storeUrl: document.getElementById("store-url").value,
              clientContact: email,
              planType: planType,
              expiresAt: new Date(
                document.getElementById("expires-at").value + "T23:59:59"
              ),
              createdAt: serverTimestamp(),
              key: key,
              paymentId: paymentData.id, // ID do Abacate Pay para vincular
              paymentLink: paymentData.url,
              active: false, // Começa inativa
              status: "aguardando_pagamento",
            };

            await addDoc(collection(db, "licenses"), licenseData);

            const keyContainer = document.getElementById("generated-key");
            keyContainer.innerHTML = `
            <div class="flex flex-col gap-4 text-left">
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                    <p class="font-bold text-yellow-800"><i class="fas fa-exclamation-triangle"></i> Licença criada (Inativa)</p>
                    <p class="text-sm text-yellow-700">Envie o link abaixo para o cliente pagar e ativar a chave.</p>
                </div>
                <div>
                    <span class="text-sm font-bold text-gray-600">Link de Pagamento:</span>
                    <div class="flex gap-2 mt-1">
                        <input type="text" value="${paymentData.url}" class="flex-1 p-2 border rounded text-sm bg-gray-50" readonly>
                        <button onclick="window.copiarChave('${paymentData.url}')" class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700">Copiar</button>
                    </div>
                </div>
                <div>
                    <span class="text-sm font-bold text-gray-600">Chave da Licença:</span>
                    <div class="flex gap-2 mt-1">
                        <input type="text" value="${key}" class="flex-1 p-2 border rounded text-sm bg-gray-50 font-mono" readonly>
                        <button onclick="window.copiarChave('${key}')" class="bg-gray-600 text-white px-3 rounded hover:bg-gray-700">Copiar</button>
                    </div>
                </div>
            </div>
          `;
            keyContainer.classList.remove("hidden");

            e.target.reset();
            loadLicenses();
          } catch (error) {
            console.error(error);
            let msg = error.message;
            if (msg === "Failed to fetch") {
                msg = "Não foi possível conectar ao servidor. Verifique se o backend (Vercel) está rodando (use 'vercel dev').";
            }
            alert("Erro ao gerar licença: " + msg);
          } finally {
            btn.innerText = originalText;
            btn.disabled = false;
          }
        });

      // Listener de Busca
      document
        .getElementById("search-license")
        .addEventListener("input", (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = allLicensesData.filter(
            (l) =>
              l.storeName.toLowerCase().includes(term) ||
              l.clientContact.toLowerCase().includes(term) ||
              l.storeUrl.toLowerCase().includes(term)
          );
          renderLicensesTable(filtered);
        });

      // Carregar Licenças
      async function loadLicenses() {
        const querySnapshot = await getDocs(collection(db, "licenses"));
        allLicensesData = [];
        const stats = {}; // { "2023-10": { clientes: 0, faturamento: 0 } }

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          allLicensesData.push({ id: doc.id, ...data });

          // Processar Estatísticas
          if (data.createdAt) {
            const date = data.createdAt.toDate();
            const key = `${date.getFullYear()}-${String(
              date.getMonth() + 1
            ).padStart(2, "0")}`;

            if (!stats[key]) stats[key] = { clientes: 0, faturamento: 0 };

            stats[key].clientes++;
            const valor = data.planType === "anual" ? 990 : 99;
            stats[key].faturamento += valor;
          }
        });

        renderLicensesTable(allLicensesData);
        renderCharts(stats);
      }

      function renderLicensesTable(licenses) {
        const tableBody = document.getElementById("licenses-table");
        tableBody.innerHTML = "";

        // Base URL para o contrato
        const baseUrl =
          window.location.origin +
          window.location.pathname.substring(
            0,
            window.location.pathname.lastIndexOf("/")
          ) +
          "/contrato.html";

        licenses.forEach((data) => {
          const expiresDateObj = data.expiresAt.toDate();
          const expiresDate = expiresDateObj.toLocaleDateString("pt-BR");
          const isExpired = expiresDateObj < new Date();
          const contractUrl = `${baseUrl}?key=${data.key}`;

          const contractStatus = data.contractAccepted
            ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Assinado</span>'
            : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pendente</span>';

          const paymentStatus = data.active
            ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Ativa</span>'
            : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Aguardando Pagto</span>';

          const row = `
                    <tr class="${isExpired ? "bg-red-50" : ""}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${
                              data.storeName
                            }</div>
                            <div class="text-sm text-gray-500">${
                              data.storeUrl
                            }</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono" id="license-key-${
                          doc.id
                        }">
                          ${data.key} <button onclick="window.copiarChave('${
            data.key
          }')" class="ml-2 text-blue-500 hover:text-blue-700" title="Copiar"><i class="fas fa-copy"></i></button></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                          data.planType
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${expiresDate}<br>${paymentStatus}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${contractStatus}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="window.copiarChave('${contractUrl}')" class="text-purple-600 hover:text-purple-900 mr-3" title="Copiar Link Contrato"><i class="fas fa-file-contract"></i> Link</button>
                            <button onclick="window.editLicense('${
                              data.id
                            }')" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar"><i class="fas fa-edit"></i></button>
                            <button onclick="window.renewLicense('${
                              data.id
                            }')" class="text-green-600 hover:text-green-900 mr-3" title="Renovar +30 dias"><i class="fas fa-calendar-plus"></i></button>
                            <button data-id="${
                              data.id
                            }" class="delete-btn text-red-600 hover:text-red-900" title="Excluir Licença"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
          tableBody.innerHTML += row;
        });

        // Adicionar event listeners para os botões de exclusão
        document.querySelectorAll(".delete-btn").forEach((button) => {
          button.addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            if (confirm("Tem certeza que deseja excluir esta licença?")) {
              await deleteDoc(doc(db, "licenses", id));
              loadLicenses();
            }
          });
        });
      }

      // Funções Globais de Edição e Renovação
      window.editLicense = (id) => {
        const license = allLicensesData.find((l) => l.id === id);
        if (!license) return;

        document.getElementById("edit-id").value = id;
        document.getElementById("edit-store-name").value = license.storeName;
        document.getElementById("edit-company-name").value =
          license.companyName || "";
        document.getElementById("edit-cnpj").value = license.cnpj || "";
        document.getElementById("edit-store-url").value = license.storeUrl;
        document.getElementById("edit-client-contact").value =
          license.clientContact;
        document.getElementById("edit-address").value = license.address || "";
        // Formata data para input date (YYYY-MM-DD)
        const date = license.expiresAt.toDate();
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, "0");
        const dd = String(date.getDate()).padStart(2, "0");
        document.getElementById(
          "edit-expires-at"
        ).value = `${yyyy}-${mm}-${dd}`;

        const modal = document.getElementById("edit-modal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      };

      document
        .getElementById("edit-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("edit-id").value;
          const updates = {
            storeName: document.getElementById("edit-store-name").value,
            companyName: document.getElementById("edit-company-name").value,
            cnpj: document.getElementById("edit-cnpj").value,
            storeUrl: document.getElementById("edit-store-url").value,
            clientContact: document.getElementById("edit-client-contact").value,
            address: document.getElementById("edit-address").value,
            expiresAt: new Date(
              document.getElementById("edit-expires-at").value + "T23:59:59"
            ),
          };
          await updateDoc(doc(db, "licenses", id), updates);
          closeEditModal();
          loadLicenses();
        });

      window.renewLicense = async (id) => {
        const license = allLicensesData.find((l) => l.id === id);
        if (!license) return;

        if (
          confirm(`Renovar licença de ${license.storeName} por mais 30 dias?`)
        ) {
          const currentExpire = license.expiresAt.toDate();
          // Adiciona 30 dias
          currentExpire.setDate(currentExpire.getDate() + 30);
          await updateDoc(doc(db, "licenses", id), {
            expiresAt: currentExpire,
          });
          loadLicenses();
        }
      };

      function renderCharts(stats) {
        const sortedKeys = Object.keys(stats).sort();
        const labels = sortedKeys.map((monthYear) => {
          const [year, month] = monthYear.split("-");
          const monthNames = [
            "Jan",
            "Fev",
            "Mar",
            "Abr",
            "Mai",
            "Jun",
            "Jul",
            "Ago",
            "Set",
            "Out",
            "Nov",
            "Dez",
          ];
          return `${monthNames[parseInt(month) - 1]}/${year.slice(2)}`;
        });
        const dataClientes = sortedKeys.map((k) => stats[k].clientes);
        const dataFaturamento = sortedKeys.map((k) => stats[k].faturamento);

        // Gráfico Clientes
        if (chartClientesInstance) chartClientesInstance.destroy();
        chartClientesInstance = new Chart(
          document.getElementById("chartClientes"),
          {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Novas Licenças",
                  data: dataClientes,
                  borderColor: "#2563eb",
                  tension: 0.3,
                  fill: true,
                  backgroundColor: "rgba(37, 99, 235, 0.2)",
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `Novas Licenças: ${context.parsed.y}`;
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Quantidade",
                  },
                },
              },
            },
          }
        );

        // Gráfico Faturamento
        if (chartFaturamentoInstance) chartFaturamentoInstance.destroy();
        chartFaturamentoInstance = new Chart(
          document.getElementById("chartFaturamento"),
          {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Faturamento Estimado (R$)",
                  data: dataFaturamento,
                  backgroundColor: "#16a34a",
                  borderColor: "#15803d",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `Faturamento: R$ ${context.parsed.y
                        .toFixed(2)
                        .replace(".", ",")}`;
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Valor (R$)",
                  },
                  ticks: {
                    callback: function (value) {
                      return "R$ " + value.toFixed(2).replace(".", ",");
                    },
                  },
                },
              },
            },
          }
        );
      }

      // Carregar Tickets (Realtime)
      function loadTickets() {
        const q = query(
          collection(db, "tickets"),
          orderBy("updatedAt", "desc")
        );
        onSnapshot(q, (snapshot) => {
          const container = document.getElementById("tickets-container");
          container.innerHTML = "";

          if (snapshot.empty) {
            container.innerHTML =
              '<p class="p-6 text-gray-500 text-center">Nenhum ticket de suporte encontrado.</p>';
            return;
          }

          snapshot.forEach((doc) => {
            const t = doc.data();
            const lastMsg = t.messages[t.messages.length - 1];
            const statusColors = {
              open: "bg-yellow-100 text-yellow-800",
              answered: "bg-green-100 text-green-800",
              closed: "bg-gray-100 text-gray-800",
            };
            const statusLabels = {
              open: "Aberto",
              answered: "Respondido",
              closed: "Fechado",
            };

            const div = document.createElement("div");
            div.className = "p-6 hover:bg-gray-50 transition cursor-pointer";
            div.innerHTML = `
                      <div class="flex justify-between items-start">
                          <div>
                              <div class="flex items-center gap-2 mb-1">
                                  <span class="px-2 py-0.5 rounded text-xs font-bold ${
                                    statusColors[t.status] || "bg-gray-100"
                                  }">${
              statusLabels[t.status] || t.status
            }</span>
                                  <h3 class="text-lg font-medium text-gray-900">${
                                    t.subject
                                  }</h3>
                              </div>
                              <p class="text-sm text-gray-500">Loja: <strong>${
                                t.storeName
                              }</strong></p>
                              <p class="text-sm text-gray-600 mt-2 line-clamp-1 text-ellipsis overflow-hidden">
                                  ${
                                    lastMsg
                                      ? lastMsg.text
                                      : "Nenhuma mensagem ainda."
                                  }
                              </p>
                              <button onclick="markTicketAsClosed('${
                                doc.id
                              }')" class="mt-2 text-xs text-gray-500 hover:text-gray-700"><i class="fas fa-check-circle"></i> Marcar como Resolvido</button>
                          </div>
                          <div class="text-right text-xs text-gray-400">
                              ${
                                t.updatedAt
                                  ? new Date(
                                      t.updatedAt.toDate()
                                    ).toLocaleDateString()
                                  : ""
                              }
                          </div>
                      </div>
                  `;
            div.onclick = () => openReplyModal(doc.id, t.subject, t.messages);
            container.appendChild(div);
          });
        });
      }

      // Marcar Ticket como Resolvido
      async function markTicketAsClosed(ticketId) {
        if (
          confirm("Tem certeza que deseja marcar este ticket como RESOLVIDO?")
        ) {
          await updateDoc(doc(db, "tickets", ticketId), {
            status: "closed",
            updatedAt: serverTimestamp(),
          });
        }
      }
    </script>
  </body>
</html>
</html>
